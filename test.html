<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite Worker Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è SQLite Worker Test</h1>
        <div id="status" class="status info">Initializing...</div>
        
        <div>
            <h3>Database Operations</h3>
            <button id="initDb" disabled>Initialize Database</button>
            <button id="createTable" disabled>Create Test Table</button>
            <button id="insertData" disabled>Insert Sample Data</button>
            <button id="clearAndInsert" disabled>Clear & Insert Fresh Data</button>
            <button id="queryData" disabled>Query Data</button>
        </div>

        <div>
            <h3>Custom SQL Query</h3>
            <p><small>üí° You can query directly after initializing the database - no need to create tables first!</small></p>
            <textarea id="sqlInput" placeholder="Enter SQL query here..." disabled>SELECT name FROM sqlite_master WHERE type='table';</textarea>
            <button id="executeQuery" disabled>Execute Query</button>
        </div>

        <div>
            <h3>Results</h3>
            <div id="results" class="results">No results yet...</div>
        </div>
    </div>

    <script type="module">
        import init, { DatabaseConnection } from './pkg/sqlite_worker.js';
        
        let db = null;
        let isInitialized = false;

        const statusEl = document.getElementById('status');
        const resultsEl = document.getElementById('results');
        const sqlInput = document.getElementById('sqlInput');
        
        const buttons = {
            initDb: document.getElementById('initDb'),
            createTable: document.getElementById('createTable'),
            insertData: document.getElementById('insertData'),
            clearAndInsert: document.getElementById('clearAndInsert'),
            queryData: document.getElementById('queryData'),
            executeQuery: document.getElementById('executeQuery')
        };

        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function enableButtons(...buttonNames) {
            buttonNames.forEach(name => {
                if (buttons[name]) buttons[name].disabled = false;
            });
        }

        function appendResults(message) {
            const timestamp = new Date().toLocaleTimeString();
            resultsEl.textContent += `[${timestamp}] ${message}\n`;
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }

        async function executeSQL(sql, description = 'Query') {
            try {
                updateStatus(`Executing: ${description}...`, 'info');
                appendResults(`Executing: ${sql}`);
                
                const result = await db.query(sql);
                appendResults(`‚úÖ Success: ${result}`);
                updateStatus(`${description} completed successfully`, 'success');
                return result;
            } catch (error) {
                const errorMsg = `‚ùå Error: ${error.message || error}`;
                appendResults(errorMsg);
                updateStatus(`${description} failed: ${error.message || error}`, 'error');
                throw error;
            }
        }

        // Initialize WASM module
        async function initialize() {
            try {
                updateStatus('Loading WASM module...', 'info');
                await init();
                updateStatus('WASM module loaded successfully', 'success');
                enableButtons('initDb');
                
            } catch (error) {
                updateStatus(`Failed to load WASM: ${error.message}`, 'error');
                appendResults(`‚ùå WASM initialization failed: ${error}`);
            }
        }

        // Initialize database connection
        buttons.initDb.addEventListener('click', async () => {
            try {
                updateStatus('Initializing database connection...', 'info');
                db = new DatabaseConnection();
                
                // Wait a moment for worker to be ready
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                isInitialized = true;
                updateStatus('Database connection established', 'success');
                appendResults('‚úÖ Database worker initialized');
                
                enableButtons('createTable', 'insertData', 'clearAndInsert', 'queryData', 'executeQuery');
                sqlInput.disabled = false;
                
            } catch (error) {
                updateStatus(`Database initialization failed: ${error.message}`, 'error');
                appendResults(`‚ùå Database init failed: ${error}`);
            }
        });

        // Create test table
        buttons.createTable.addEventListener('click', async () => {
            const sql = `
                CREATE TABLE IF NOT EXISTS users (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    email TEXT UNIQUE,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `;
            try {
                await executeSQL(sql, 'Create table');
            } catch (error) {
                console.error('Create table failed:', error);
            }
        });

        // Insert sample data
        buttons.insertData.addEventListener('click', async () => {
            const insertQueries = [
                "INSERT OR IGNORE INTO users (name, email) VALUES ('Alice', 'alice@example.com')",
                "INSERT OR IGNORE INTO users (name, email) VALUES ('Bob', 'bob@example.com')",
                "INSERT OR IGNORE INTO users (name, email) VALUES ('Charlie', 'charlie@example.com')"
            ];
            
            try {
                for (const sql of insertQueries) {
                    await executeSQL(sql, 'Insert data');
                }
                appendResults('üí° Used INSERT OR IGNORE to handle duplicate emails gracefully');
            } catch (error) {
                console.error('Insert data failed:', error);
            }
        });

        // Clear and insert fresh data
        buttons.clearAndInsert.addEventListener('click', async () => {
            try {
                // First clear existing data
                await executeSQL("DELETE FROM users", 'Clear existing data');
                
                // Then insert fresh data with timestamps
                const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
                const insertQueries = [
                    `INSERT INTO users (name, email) VALUES ('Alice', 'alice@example.com')`,
                    `INSERT INTO users (name, email) VALUES ('Bob', 'bob@example.com')`,
                    `INSERT INTO users (name, email) VALUES ('Charlie', 'charlie@example.com')`,
                    `INSERT INTO users (name, email) VALUES ('Diana (${timestamp})', 'diana_${Date.now()}@example.com')`
                ];
                
                for (const sql of insertQueries) {
                    await executeSQL(sql, 'Insert fresh data');
                }
                appendResults('‚úÖ Cleared old data and inserted fresh records with unique IDs');
            } catch (error) {
                console.error('Clear and insert failed:', error);
            }
        });

        // Query data
        buttons.queryData.addEventListener('click', async () => {
            const sql = "SELECT * FROM users ORDER BY id";
            try {
                await executeSQL(sql, 'Query users');
            } catch (error) {
                console.error('Query data failed:', error);
            }
        });

        // Execute custom query
        buttons.executeQuery.addEventListener('click', async () => {
            const sql = sqlInput.value.trim();
            if (!sql) {
                updateStatus('Please enter a SQL query', 'error');
                return;
            }
            
            try {
                await executeSQL(sql, 'Custom query');
            } catch (error) {
                console.error('Custom query failed:', error);
            }
        });

        // Start initialization
        initialize();
    </script>
</body>
</html>